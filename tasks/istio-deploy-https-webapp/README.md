## Environment Requirements
```
Public ip for istio-ingressgateway -> GCP Load balancing service
GKE 1.14.6-gke-13
    2 node
    2 vCPU
    7.5 GB memroy
    100 GB disk
Your own DNS configuration
```

## Required components
```
GKE 1.14.6-gke-13
helm
    istio-init
    istio
    cert-manager
```

## Environmental variables
```
EMAIL=
FQDN=
```

## helm installation
```
sudo curl -O https://get.helm.sh/helm-v2.14.1-linux-amd64.tar.gz && \
sudo tar -zxvf helm-v2.14.1-linux-amd64.tar.gz && \
sudo cp linux-amd64/helm /usr/local/bin/

cat <<EOF | kubectl create -f -
apiVersion: v1
kind: ServiceAccount
metadata:
  name: tiller
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRoleBinding
metadata:
  name: tiller
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
  - kind: ServiceAccount
    name: tiller
    namespace: kube-system
EOF

helm init --service-account tiller --skip-refresh
helm repo update
```

## Istio installation with sds enabled
```
helm repo add istio.io https://storage.googleapis.com/istio-release/releases/1.1.2/charts/
helm repo update

helm install istio.io/istio-init --name istio-init --namespace istio-system

helm install istio.io/istio \
       --name istio \
       --namespace istio-system \
       --set gateways.istio-ingressgateway.sds.enabled=true
```

## Cert-manager Install the CustomResourceDefinition resources separately
```kubectl apply -f https://raw.githubusercontent.com/jetstack/cert-manager/release-0.7/deploy/manifests/00-crds.yaml```

## Cert-manager
```
kubectl create namespace cert-manager
kubectl label namespace cert-manager certmanager.k8s.io/disable-validation=true
helm repo add jetstack https://charts.jetstack.io
helm repo update
helm install jetstack/cert-manager --version v0.10.1 --namespace cert-manager --name cert-manager
```

## Letâ€™s get your external IP from the Istio ingress gateway
kubectl get svc -n istio-system istio-ingressgateway

## Create A record for the webapp that points to istio-ingressgateway load balancer ip from the previous step

## Issuer for staging
```
cat <<EOF | kubectl apply -f -
apiVersion: certmanager.k8s.io/v1alpha1
kind: Issuer
metadata:
  name: letsencrypt-staging
  namespace: istio-system
spec:
  acme:
    email: ${EMAIL}
    server: https://acme-staging-v02.api.letsencrypt.org/directory
    privateKeySecretRef:
      # Secret resource used to store the account's private key.
      name: example-issuer-account-key
    http01: {}
---
EOF
```

## Issuer status, expecting to see Status: True and Type: Ready
```kubectl describe issuer -n istio-system```

## Create a simple gateway with a specific name (istio-autogenerated-k8s-ingress) listening everything on port 80
```
cat <<EOF | kubectl apply -f -
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: istio-autogenerated-k8s-ingress
  namespace: istio-system
  labels:
    app: ingressgateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      protocol: HTTP2
      name: http
    hosts:
    - "*"
---
EOF
```
## Generating certificates for the book info sample, we will use the 'book-certificate'
```
cat <<EOF | kubectl apply -f -
apiVersion: certmanager.k8s.io/v1alpha1
kind: Certificate
metadata:
  name: book-certificate
  namespace: istio-system
spec:
  secretName: book-certificate
  issuerRef:
    name: letsencrypt-staging
  commonName: ${FQDN}
  dnsNames:
  - ${FQDN}
  acme:
    config:
    - http01:
        ingressClass: istio
      domains:
      - ${FQDN}
---
EOF
```

## status should turn to True from False in a few seconds or minutes
```kubectl describe certificate -n istio-system```

## Create Gateway for handling request to your webapp from ${FQDN}
```
cat <<EOF | kubectl apply -f -
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: book-gateway
  namespace: istio-system
  labels:
    app: ingressgateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 443
      protocol: HTTPS
      name: https-default
    tls:
      mode: SIMPLE
      serverCertificate: "sds"
      privateKey: "sds"
      credentialName: "book-certificate"
    hosts:
    - "${FQDN}"
---
EOF
```
## You can use openssl client to check if everything is good:
```openssl s_client -connect ${FQDN}:443```

## Deploying the book info sample
```
kubectl create ns book
kubectl label ns book istio-injection=enabled
kubectl apply -n book -f https://raw.githubusercontent.com/istio/istio/1.1.2/samples/bookinfo/platform/kube/bookinfo.yaml
```
## VirtualService
```
cat <<EOF | kubectl apply -f -
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: bookinfo
  namespace: book
spec:
  hosts:
  - "${FQDN}"
  gateways:
  - istio-system/book-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage
        port:
          number: 9080
---
EOF
```
## Browse https://book.busyapi.com/productpage, ssl should work with a fake certificate

## Issuer for prod
```
cat <<EOF | kubectl create -f -
apiVersion: certmanager.k8s.io/v1alpha1
kind: Issuer
metadata:
  name: letsencrypt-prod
  namespace: istio-system
spec:
  acme:
    # The ACME server URL
    server: https://acme-v02.api.letsencrypt.org/directory
    # Email address used for ACME registration
    email: ${EMAIL}
    # Name of a secret used to store the ACME account private key
    privateKeySecretRef:
      name: letsencrypt-prod
    # Enable the HTTP-01 challenge provider
    http01: {}
EOF
```

## Certificate for prod
```
cat <<EOF | kubectl apply -f -
apiVersion: certmanager.k8s.io/v1alpha1
kind: Certificate
metadata:
  name: book-certificate
  namespace: istio-system
spec:
  secretName: book-certificate
  issuerRef:
    name: letsencrypt-prod
  commonName: ${FQDN}
  dnsNames:
  - ${FQDN}
  acme:
    config:
    - http01:
        ingressClass: istio
      domains:
      - ${FQDN}
---
EOF
```

## Now browse https://${FQDN}/productpage, it should be fully working
